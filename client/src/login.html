<html>
  <head>
    <partial src="head-scripts.html"></partial>
    <script>
      const AppBridge = window["app-bridge"];
      const createApp = AppBridge.createApp;
      const apiKey = "{SHOPIFY_API_KEY}";
      const redirectUri = `{CLOUD_FUNCTION_ENDPOINT}/oauthCallback`;
      const permissionUrl =
        `/oauth/authorize?client_id=${apiKey}` +
        `&scope=read_script_tags,write_script_tags&redirect_uri=${redirectUri}`;
      const urlParams = new URLSearchParams(window.location.search);
      const token = getCookie("access_token");
      const shopOrigin = urlParams.get("shop");
      const app = createApp({
        apiKey: apiKey,
        shopOrigin: shopOrigin,
      });
      const Redirect = AppBridge.actions.Redirect;
      const redirect = Redirect.create(app);

      if (!!token) {
        fetch(
          `{CLOUD_FUNCTION_ENDPOINT}/getResource` +
            `?shop=${shopOrigin}&token=${token}&resource=shop`
        )
          .then((response) => response.json())
          .then(goToIndex)
          .catch(oauth);
      } else {
        oauth();
      }

      function oauth() {
        redirect.dispatch(Redirect.Action.ADMIN_PATH, permissionUrl);
      }

      function goToIndex() {
        redirect.dispatch(
          Redirect.Action.APP,
          `/index.html?shop=${shopOrigin}&access_token=${token}`
        );
      }
    </script>
  </head>

  <body>
    <div class="main">
      <div class="content">
        <div class="loading">
          <div class="lds-ellipsis">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
